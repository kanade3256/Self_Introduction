---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import Bubbles from '../../components/Bubbles.astro';

const allProjects = await getCollection('projects');
const sortedProjects = allProjects.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const basePath = (import.meta.env.BASE_URL ?? '/').replace(/\/$/, '');
const joinBase = (path: string) => {
  const normalized = path.startsWith('/') ? path : '/' + path;
  return basePath ? basePath + normalized : normalized;
};
const projectDetailHref = (slug: string) => joinBase('/projects/' + slug);
---

<Base title="プロジェクト一覧" description="研究・実務・個人開発で取り組んだプロジェクト一覧。成果とKPIを明確化したプロダクト開発の軌跡。">
  <!-- ブレッドクラム -->
  <nav class="breadcrumb-nav">
    <div class="layout-container">
      <ol class="breadcrumb-list">
        <li class="breadcrumb-item">
          <a href="/" class="breadcrumb-link">ホーム</a>
        </li>
        <li class="breadcrumb-item">
          <span class="breadcrumb-current">プロジェクト</span>
        </li>
      </ol>
    </div>
  </nav>

  <!-- プロジェクト一覧ページ -->
  <div class="on-deep" style="position: relative; min-height: 100vh;">
    <!-- バブルエフェクトを追加 -->
    <Bubbles count={14} />

    <section class="section section--hero">
      <div class="layout-container">
        <header class="section__header">
          <p class="section__eyebrow">Project Archive</p>
          <h1 class="section__title">プロジェクト一覧</h1>
          <p class="section__lead">研究・実務・個人開発で取り組んだプロジェクト。成果・KPI・技術スタックを明確化し、背景と学びを整理しています。</p>
        </header>
      </div>
    </section>

    <section class="section">
      <div class="layout-container">
        <div class="project-catalog">
          {sortedProjects.map((project) => (
            <article class="project-catalog__item card-glass card-glass--roomy reveal" data-category={project.data.category}>
              <div class="project-catalog__header">
                <div class="project-catalog__meta">
                  <span class="badge badge--soft" data-category={project.data.category}>
                    {project.data.category}
                  </span>
                  {project.data.period && (
                    <span class="project-catalog__period">{project.data.period}</span>
                  )}
                  {project.data.status && (
                    <span class="badge badge--pill" data-status={project.data.status}>
                      {project.data.status === 'ongoing' ? '進行中' : 
                       project.data.status === 'completed' ? '完了' : '一時停止'}
                    </span>
                  )}
                </div>
                <h2 class="project-catalog__title">{project.data.title}</h2>
                <p class="project-catalog__role">{project.data.role}</p>
              </div>

              <p class="project-catalog__summary">{project.data.summary}</p>

              {/* 主な成果 */}
              {project.data.achievements && project.data.achievements.length > 0 && (
                <div class="project-catalog__achievements">
                  <h4>主な成果</h4>
                  <ul class="achievement-list" role="list">
                    {project.data.achievements.slice(0, 3).map((achievement) => (
                      <li role="listitem">{achievement}</li>
                    ))}
                  </ul>
                </div>
              )}

              {/* 技術スタック */}
              <div class="project-catalog__tech">
                <h4>技術スタック</h4>
                <ul class="project-catalog__tags" role="list">
                  {project.data.technologies.slice(0, 6).map((tech) => (
                    <li class="badge badge--pill" role="listitem">{tech}</li>
                  ))}
                </ul>
              </div>

              <div class="project-catalog__actions">
                {project.data.links?.demo && (
                  <a class="btn btn--ghost btn--sm" href={project.data.links.demo} target="_blank" rel="noopener noreferrer prefetch">
                    <span>Live Demo</span>
                  </a>
                )}
                {project.data.links?.repo && (
                  <a class="btn btn--ghost btn--sm" href={project.data.links.repo} target="_blank" rel="noopener noreferrer prefetch">
                    <span>GitHub</span>
                  </a>
                )}
                {project.data.links?.github && (
                  <a class="btn btn--ghost btn--sm" href={project.data.links.github} target="_blank" rel="noopener noreferrer prefetch">
                    <span>GitHub</span>
                  </a>
                )}
                {project.data.links?.pdf && (
                  <a class="btn btn--ghost btn--sm" href={project.data.links.pdf} target="_blank" rel="noopener noreferrer prefetch">
                    <span>論文・資料</span>
                  </a>
                )}
                <a class="btn btn--primary btn--sm" href={projectDetailHref(project.slug)} rel="prefetch">
                  <span>詳細を見る</span>
                </a>
              </div>
            </article>
          ))}
        </div>

        {/* 追加プロジェクト予定 */}
        <div class="section__footer">
          <div class="card-glass card-glass--tight reveal" style="text-align: center;">
            <h3 style="margin: 0 0 1rem;">現在開発中・計画中のプロジェクト</h3>
            <p style="margin: 0 0 1.5rem; color: var(--muted);">
              新しいプロジェクトや継続中の研究開発について、近日中にアップデート予定です。
            </p>
            <a href="/#contact" class="btn btn--ghost" rel="prefetch">
              <span>プロジェクトについて相談する</span>
            </a>
          </div>
        </div>
      </div>
    </section>
  </div>
</Base>
