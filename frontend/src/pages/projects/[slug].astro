---
import { getCollection, getEntry } from 'astro:content';
import Base from '../../layouts/Base.astro';
import Bubbles from '../../components/Bubbles.astro';

// 静的ルート生成のためのgetStaticPaths
export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await project.render();
const { data } = project;

// SEO用のmeta descriptionとcanonical URL
const metaDescription = data.summary || `${data.title}のプロジェクト詳細。技術スタック、成果、成果物の紹介。`;
const canonicalURL = new URL(`/projects/${project.slug}/`, Astro.site || 'https://example.com');

// 構造化データ用のデータ準備
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  "name": data.title,
  "description": metaDescription,
  "author": {
    "@type": "Person",
    "name": "Kanato Murayama",
    "url": "https://github.com/kanade3256"
  },
  "url": canonicalURL.toString(),
  "datePublished": data.date.toISOString().split('T')[0],
  "keywords": data.technologies?.join(", "),
  "about": data.category
};

// リンクがある場合は追加
if (data.links?.demo) {
  (structuredData as any).sameAs = data.links.demo;
}
if (data.links?.repo || data.links?.github) {
  (structuredData as any).codeRepository = data.links.repo || data.links.github;
}
---

<Base 
  title={data.title} 
  description={metaDescription}
  canonicalURL={canonicalURL.toString()}
  structuredData={structuredData}
>
  <!-- ブレッドクラム -->
  <nav class="breadcrumb-nav">
    <div class="layout-container">
      <ol class="breadcrumb-list">
        <li class="breadcrumb-item">
          <a href="/" class="breadcrumb-link">ホーム</a>
        </li>
        <li class="breadcrumb-item">
          <a href="/projects" class="breadcrumb-link">プロジェクト</a>
        </li>
        <li class="breadcrumb-item">
          <span class="breadcrumb-current">{project.data.title}</span>
        </li>
      </ol>
    </div>
  </nav>

  <!-- プロジェクト詳細記事 -->
  <article class="project-detail on-deep" style="position: relative; min-height: 100vh;">
    <!-- バブルエフェクトを追加 -->
    <Bubbles count={8} />

    <!-- プロジェクトヘッダー -->
    <section class="section section--hero project-hero">
      <div class="layout-container">
        <div class="project-hero__content">
          <!-- メタ情報 -->
          <div class="project-hero__meta">
            <span class="badge badge--soft" data-category={project.data.category}>
              {project.data.category}
            </span>
            {project.data.status && (
              <span class="badge badge--pill" data-status={project.data.status}>
                {project.data.status === 'ongoing' ? '進行中' : 
                 project.data.status === 'completed' ? '完了' : '一時停止'}
              </span>
            )}
            {project.data.period && (
              <time class="project-hero__period" datetime={project.data.date.toISOString()}>
                {project.data.period}
              </time>
            )}
          </div>

          <h1 class="project-hero__title reveal">{project.data.title}</h1>
          <p class="project-hero__summary reveal">{project.data.summary}</p>

          <!-- アクションボタン -->
          {project.data.links && Object.keys(project.data.links).length > 0 && (
            <div class="project-hero__actions reveal">
              {project.data.links.demo && (
                <a href={project.data.links.demo} target="_blank" rel="noopener noreferrer prefetch" class="btn btn--primary">
                  <span>デモを見る</span>
                </a>
              )}
              {project.data.links.repo && (
                <a href={project.data.links.repo} target="_blank" rel="noopener noreferrer prefetch" class="btn btn--ghost">
                  <span>GitHub</span>
                </a>
              )}
              {project.data.links.github && (
                <a href={project.data.links.github} target="_blank" rel="noopener noreferrer prefetch" class="btn btn--ghost">
                  <span>GitHub</span>
                </a>
              )}
              {project.data.links.pdf && (
                <a href={project.data.links.pdf} target="_blank" rel="noopener noreferrer prefetch" class="btn btn--ghost">
                  <span>論文・資料</span>
                </a>
              )}
            </div>
          )}
        </div>
      </div>
    </section>

    <!-- 技術・成果情報カード -->
    <section class="section">
      <div class="layout-container">
        <div class="grid-12">
          <!-- 役割・期間 -->
          <div class="col-span-4">
            <div class="card card-glass reveal">
              <h3 class="card__title">プロジェクト概要</h3>
              <div class="project-detail__info">
                <div class="info-item">
                  <dt>役割</dt>
                  <dd>{project.data.role}</dd>
                </div>
                {project.data.period && (
                  <div class="info-item">
                    <dt>期間</dt>
                    <dd>{project.data.period}</dd>
                  </div>
                )}
                <div class="info-item">
                  <dt>カテゴリ</dt>
                  <dd>{project.data.category}</dd>
                </div>
              </div>
            </div>
          </div>

          <!-- 技術スタック -->
          <div class="col-span-4">
            <div class="card card-glass reveal">
              <h3 class="card__title">技術スタック</h3>
              <ul class="card__tags" role="list">
                {project.data.technologies.map((tech) => (
                  <li class="badge badge--soft" role="listitem">{tech}</li>
                ))}
              </ul>
            </div>
          </div>

          <!-- 主な成果 -->
          <div class="col-span-4">
            <div class="card card-glass reveal">
              <h3 class="card__title">主な成果</h3>
              <ul class="achievement-list" role="list">
                {project.data.achievements.map((achievement) => (
                  <li role="listitem">{achievement}</li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- メインコンテンツ -->
    <section class="section">
      <div class="layout-container">
        <div class="project-content">
          <div class="card-glass card-glass--roomy reveal content-wrapper">
            <!-- カバー画像 -->
            {project.data.cover && (
              <picture>
                <source srcset={project.data.cover.replace('.jpg', '.avif')} type="image/avif" />
                <source srcset={project.data.cover.replace('.jpg', '.webp')} type="image/webp" />
                <img 
                  src={project.data.cover} 
                  alt={`${project.data.title}のカバー画像`}
                  width="900" 
                  height="506" 
                  loading="lazy"
                  decoding="async"
                  style="width:100%;height:auto;border-radius:12px;margin:2rem 0;"
                />
              </picture>
            )}
            
            <!-- Markdown コンテンツ -->
            <Content />
          </div>
        </div>
      </div>
    </section>

    <!-- タグ・キーワード -->
    {project.data.tags.length > 0 && (
      <section class="section section--layer">
        <div class="layout-container">
          <div class="section__header">
            <h3 class="section__title">関連技術・キーワード</h3>
          </div>
          <div class="card-glass card-glass--tight reveal">
            <ul class="card__tags" role="list">
              {project.data.tags.map((tag) => (
                <li class="badge badge--pill" role="listitem">{tag}</li>
              ))}
            </ul>
          </div>
        </div>
      </section>
    )}

    <!-- ナビゲーション -->
    <section class="section">
      <div class="layout-container">
        <nav class="project-navigation reveal" aria-label="プロジェクトナビゲーション">
          <div class="nav-actions">
            <a href="/projects" class="btn btn--ghost">
              <span>← プロジェクト一覧</span>
            </a>
            <a href="/#contact" rel="prefetch" class="btn btn--primary">
              <span>このプロジェクトについて相談する</span>
            </a>
          </div>
        </nav>
      </div>
    </section>
  </article>
</Base>